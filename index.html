<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Interactive Timeline</title>
  <link rel="stylesheet" href="assets/styles.css">
</head>
<body>
  <div id="timeline"></div>

  <script>
    // --- Helper functions for avatar initials & colors ---
    function getInitials(name) {
      return name
        .split(' ')
        .map(n => n[0].toUpperCase())
        .slice(0, 2)
        .join('');
    }

    function getColor(name) {
      const colors = ['#1DA1F2', '#17BF63', '#E0245E', '#794BC4', '#FFAD1F', '#F45D22'];
      const index = name.charCodeAt(0) % colors.length;
      return colors[index];
    }

    // --- Load posts and render timeline ---
    fetch('data/posts.json')
      .then(res => res.json())
      .then(posts => {
        const timeline = document.getElementById('timeline');

        posts.forEach(post => {
          const div = document.createElement('div');
          div.className = 'post';
          div.innerHTML = `
            <div class="avatar" style="background:${getColor(post.author)}">
              ${getInitials(post.author)}
            </div>
            <div class="content">
              <p><strong>${post.author}</strong></p>
              <p>${post.text}</p>

              <div class="actions">
                â¤ï¸ <span id="like-${post.id}">${post.likes}</span>â€ƒ
                ğŸ” <span id="retweet-${post.id}">${post.retweets}</span>â€ƒ
                ğŸ’¬ <span id="comment-count-${post.id}">${post.comments}</span>
              </div>

              <div class="timeline-buttons">
                <button onclick="likePost('${post.id}')">â¤ï¸ Like</button>
                <button onclick="retweetPost('${post.id}')">ğŸ” Repost</button>
                <button onclick="toggleCommentBox('${post.id}')">ğŸ’¬ Comment</button>
                <button onclick="openPost('${post.id}')">View Conversation</button>
              </div>

              <div id="comment-box-${post.id}" class="comment-box" style="display:none; margin-top:10px;">
                <textarea id="comment-input-${post.id}" rows="2" style="width:100%;"></textarea><br>
                <button onclick="submitComment('${post.id}')">Submit Comment</button>
              </div>

              <div id="comments-${post.id}" class="comment-section"></div>
            </div>
          `;
          timeline.appendChild(div);
        });
      });

    // --- State tracking ---
    const postData = {};

    // --- Interactions ---
    function likePost(postId) {
      if (!postData[postId]) postData[postId] = { likes: 0, retweets: 0, comments: [] };
      postData[postId].likes++;
      document.getElementById(`like-${postId}`).textContent = postData[postId].likes;
      sendToQualtrics("like", postId);
    }

    function retweetPost(postId) {
      if (!postData[postId]) postData[postId] = { likes: 0, retweets: 0, comments: [] };
      postData[postId].retweets++;
      document.getElementById(`retweet-${postId}`).textContent = postData[postId].retweets;
      sendToQualtrics("retweet", postId);
    }

    function toggleCommentBox(postId) {
      const box = document.getElementById(`comment-box-${postId}`);
      box.style.display = box.style.display === "none" ? "block" : "none";
    }

    function submitComment(postId) {
      const input = document.getElementById(`comment-input-${postId}`);
      const text = input.value.trim();
      if (!text) return;
      if (!postData[postId]) postData[postId] = { likes: 0, retweets: 0, comments: [] };

      postData[postId].comments.push(text);
      renderComments(postId);
      input.value = "";
      document.getElementById(`comment-box-${postId}`).style.display = "none";
      sendToQualtrics("comment", { post: postId, text });
    }

    function renderComments(postId) {
      const section = document.getElementById(`comments-${postId}`);
      const comments = postData[postId]?.comments || [];
      section.innerHTML = comments
        .map(c => `<div class="reply"><strong>You:</strong> ${c}</div>`)
        .join("");
      document.getElementById(`comment-count-${postId}`).textContent = comments.length;
    }

    function openPost(postId) {
      window.location.href = `posts/${postId}.html`;
    }

    function sendToQualtrics(type, data) {
      window.parent.postMessage({ type, data }, "*");
    }
  </script>
</body>
</html>
