import asyncio
import csv
import random
from tweety import Twitter
from pathlib import Path

# Constants
MIN_DELAY = 16 * 60  # 16 minutes in seconds
MAX_DELAY = 17 * 60  # 17 minutes in seconds
OUTPUT_FOLDER = Path("Followers")
OUTPUT_FOLDER.mkdir(parents=True, exist_ok=True)

async def fetch_all_followers(app, username: str, wait_time: int = 2):
    all_followers = []
    cursor = None  # Start from the beginning

    while True:
        # Fetch one page at a time
        user_followers, followers_list = await app.get_user_followers(
            username=username, pages=1, wait_time=wait_time, cursor=cursor
        )

        if not followers_list:
            break  # No more followers

        all_followers.extend(followers_list)
        print(f"Fetched {len(followers_list)} followers, total so far: {len(all_followers)}")

        # Update cursor for next page
        cursor = getattr(user_followers, "next_cursor", None)
        if not cursor:
            break  # Reached the end

        # Random delay to avoid rate limits
        delay = random.randint(MIN_DELAY, MAX_DELAY)
        print(f"Waiting {delay / 60:.2f} minutes before next page...")
        await asyncio.sleep(delay)

    return all_followers

async def save_followers_to_csv(username: str, followers):
    if not followers:
        print("No followers found.")
        return

    filename = OUTPUT_FOLDER / f"{username}.csv"
    with open(filename, mode="w", newline="", encoding="utf-8") as file:
        writer = csv.writer(file)
        writer.writerow(["ID", "Username", "Name", "Bio", "Followers Count", "Following Count", "Verified"])
        for follower in followers:
            writer.writerow([
                follower.id,
                follower.username,
                follower.name,
                getattr(follower, "bio", ""),
                getattr(follower, "followers_count", ""),
                getattr(follower, "following_count", ""),
                getattr(follower, "verified", "")
            ])
    print(f"Saved {len(followers)} followers to {filename}")

async def main():
    # Initialize Twitter session
    app = Twitter("session")
    await app.sign_in("anon", "anon")  # Replace with real credentials if needed
    print(f"Signed in as: {app.user}")

    target_username = "exampleuser"  # Replace with your target username
    followers = await fetch_all_followers(app, target_username, wait_time=2)
    await save_followers_to_csv(target_username, followers)

# Run the script
await main()
