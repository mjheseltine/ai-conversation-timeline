<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Timeline</title>

<link rel="stylesheet" href="assets/styles.css">
<!-- Emoji Picker -->
<script src="https://cdn.jsdelivr.net/npm/@joeattardi/emoji-button@4.6.2/dist/index.js"></script>

</head>
<body>

<div class="container">
  <!-- Main Timeline -->
  <div class="main-column">
    <div id="timeline"></div>
  </div>

  <!-- Sidebar -->
  <aside class="sidebar">
    <div class="search-box">
      <input type="text" id="searchInput" placeholder="Search posts...">
    </div>

    <div class="trending">
      <h3>Trending</h3>
      <ul id="trendingList"></ul>
    </div>

    <div class="weather">
      <h3>Local Weather</h3>
      <div id="weatherBox">Loading...</div>
    </div>
  </aside>
</div>

<script>
/* ===============================
   QUALTRICS EVENT EMITTER
================================ */
function sendToQualtrics(type, data = {}) {
  window.parent.postMessage({ type, ...data }, "*");
}

/* ===============================
   HELPERS
================================ */
function initials(name) {
  return name.split(/\s+/).map(w => w[0]).join("").slice(0, 2).toUpperCase();
}

function colorFromName(name) {
  const colors = [
    "linear-gradient(135deg,#1f6feb,#3b82f6)",
    "linear-gradient(135deg,#10b981,#34d399)",
    "linear-gradient(135deg,#f59e0b,#fbbf24)",
    "linear-gradient(135deg,#ec4899,#f472b6)",
    "linear-gradient(135deg,#6366f1,#8b5cf6)"
  ];
  return colors[name.charCodeAt(0) % colors.length];
}

function highlight(text) {
  return text
    .replace(/(@[a-zA-Z0-9_]+)/g, '<span class="highlight-mention">$1</span>')
    .replace(/(#[a-zA-Z0-9_]+)/g, '<span class="highlight-hashtag">$1</span>');
}

/* ===============================
   STATE
================================ */
let timelineState = JSON.parse(sessionStorage.getItem("timelineState") || "{}");

function saveState() {
  sessionStorage.setItem("timelineState", JSON.stringify(timelineState));
}

/* ===============================
   LOAD POSTS
================================ */
const timeline = document.getElementById("timeline");

fetch("data/posts.json")
  .then(r => r.json())
  .then(posts => {
    posts.forEach(post => timeline.appendChild(createPost(post)));
  });

/* ===============================
   INTERSECTION OBSERVER (VIEWS)
================================ */
const viewObserver = new IntersectionObserver(entries => {
  entries.forEach(entry => {
    if (entry.isIntersecting) {
      const postId = entry.target.dataset.postId;
      sendToQualtrics("POST_VIEW", { postId });
      viewObserver.unobserve(entry.target);
    }
  });
}, { threshold: 0.6 });

/* ===============================
   CREATE POST
================================ */
function createPost(data) {
  let state = timelineState[data.id] || {
    likes: data.likes || 0,
    retweets: data.retweets || 0,
    comments: [],
    liked: false,
    retweeted: false
  };

  const wrapper = document.createElement("article");
  wrapper.className = "post";
  wrapper.dataset.postId = data.id;

  viewObserver.observe(wrapper);

  const avatar = document.createElement("div");
  avatar.className = "avatar";
  avatar.style.background = colorFromName(data.author);
  avatar.textContent = initials(data.author);

  const c = document.createElement("div");
  c.className = "content";

  c.innerHTML = `
    <div class="meta">
      <span class="name">${data.author}</span>
      <span class="handle">${data.handle}</span> Â· 
      <span class="time">${data.timestamp}</span>
    </div>

    <div class="text">${highlight(data.text)}</div>

    ${data.image ? `<img src="${data.image}" class="thumb">` : ""}

    <div class="actions">
      <button class="like ${state.liked ? "liked" : ""}">
        â¤ï¸ <span>${state.likes}</span>
      </button>
      <button class="retweet ${state.retweeted ? "retweeted" : ""}">
        ğŸ” <span>${state.retweets}</span>
      </button>
      <button class="comment">
        ğŸ’¬ <span>${state.comments.length}</span>
      </button>
    </div>

    <div class="comment-box" style="display:none;">
      <textarea placeholder="Write a comment..."></textarea>
      <button class="emoji-btn">ğŸ˜€</button>
      <button>Submit</button>
    </div>

    <a class="view-link" href="posts/post.html?id=${data.id}">
      View Conversation â†’
    </a>
  `;

  wrapper.append(avatar, c);

  const likeBtn = c.querySelector(".like");
  const rtBtn = c.querySelector(".retweet");
  const commentBtn = c.querySelector(".comment");
  const commentBox = c.querySelector(".comment-box");
  const submitBtn = commentBox.querySelector("button:last-of-type");
  const emojiBtn = commentBox.querySelector(".emoji-btn");
  const ta = commentBox.querySelector("textarea");
  const viewLink = c.querySelector(".view-link");

  /* --- Like --- */
  likeBtn.onclick = () => {
    state.liked = !state.liked;
    state.likes += state.liked ? 1 : -1;
    likeBtn.classList.toggle("liked", state.liked);
    likeBtn.querySelector("span").textContent = state.likes;

    sendToQualtrics("USER_LIKE", {
      postId: data.id,
      count: state.likes
    });

    timelineState[data.id] = state;
    saveState();
  };

  /* --- Retweet --- */
  rtBtn.onclick = () => {
    state.retweeted = !state.retweeted;
    state.retweets += state.retweeted ? 1 : -1;
    rtBtn.classList.toggle("retweeted", state.retweeted);
    rtBtn.querySelector("span").textContent = state.retweets;

    sendToQualtrics("USER_RETWEET", {
      postId: data.id,
      count: state.retweets
    });

    timelineState[data.id] = state;
    saveState();
  };

  /* --- Comment box toggle --- */
  commentBtn.onclick = () => {
    commentBox.style.display = "block";
    ta.focus();
    sendToQualtrics("COMMENT_BOX_OPEN", { postId: data.id });
  };

  /* --- Emoji Picker --- */
  const picker = new EmojiButton({ position: 'top-end' });
  emojiBtn.addEventListener('click', () => picker.togglePicker(emojiBtn));
  picker.on('emoji', emoji => {
    ta.value += emoji;
    ta.focus();
  });

  /* --- Comment submit --- */
  submitBtn.onclick = () => {
    const txt = ta.value.trim();
    if (!txt) return;

    state.comments.push(txt);
    ta.value = "";
    commentBox.style.display = "none";

    commentBtn.querySelector("span").textContent = state.comments.length;

    sendToQualtrics("USER_COMMENT", {
      postId: data.id,
      text: txt
    });

    timelineState[data.id] = state;
    saveState();
  };

  /* --- Open conversation --- */
  viewLink.onclick = () => sendToQualtrics("POST_OPEN", { postId: data.id });

  return wrapper;
}

/* ===============================
   SEARCH FEATURE
================================ */
const searchInput = document.getElementById("searchInput");
searchInput.addEventListener("input", (e) => {
  const query = e.target.value.toLowerCase();
  document.querySelectorAll("#timeline .post").forEach(post => {
    const text = post.querySelector(".text").textContent.toLowerCase();
    post.style.display = text.includes(query) ? "flex" : "none";
  });
});

/* ===============================
   TRENDING TOPICS
================================ */
const trendingList = document.getElementById("trendingList");
const topics = ["#AI", "#ClimateChange", "#Sports", "#TechNews", "#Music"];
topics.forEach(topic => {
  const li = document.createElement("li");
  li.textContent = topic;
  li.onclick = () => {
    searchInput.value = topic;
    searchInput.dispatchEvent(new Event("input"));
  };
  trendingList.appendChild(li);
});

/* ===============================
   LOCAL WEATHER
================================ */
const weatherBox = document.getElementById("weatherBox");
if (navigator.geolocation) {
  navigator.geolocation.getCurrentPosition(async (pos) => {
    const lat = pos.coords.latitude;
    const lon = pos.coords.longitude;
    const resp = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current_weather=true`);
    const data = await resp.json();
    const temp = data.current_weather.temperature;
    const wind = data.current_weather.windspeed;
    weatherBox.textContent = `ğŸŒ¡ï¸ ${temp}Â°C, ğŸ’¨ ${wind} km/h`;
  }, () => {
    weatherBox.textContent = "Weather unavailable";
  });
} else {
  weatherBox.textContent = "Geolocation not supported";
}

/* ===============================
   SCROLL DEPTH
================================ */
let maxScroll = 0;
window.addEventListener("scroll", () => {
  const docHeight = document.documentElement.scrollHeight - window.innerHeight;
  const depth = Math.round((window.scrollY / docHeight) * 100);
  if (depth > maxScroll) {
    maxScroll = depth;
    sendToQualtrics("SCROLL_DEPTH", { depth });
  }
});

/* ===============================
   TIME ON PAGE
================================ */
const pageStart = Date.now();
window.addEventListener("beforeunload", () => {
  sendToQualtrics("TIME_ON_PAGE", { ms: Date.now() - pageStart });
});
</script>

</body>
</html>
