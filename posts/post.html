<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Conversation</title>

<link rel="stylesheet" href="../assets/styles.css">
<!-- Emoji Picker -->
<script src="https://cdn.jsdelivr.net/npm/@joeattardi/emoji-button@4.6.2/dist/index.js"></script>

</head>
<body>

<div class="container">
  <div id="thread"></div>
  <a id="backBtn" href="../index.html">‚¨Ö Back to Timeline</a>
</div>

<script>
/* ===============================
   QUALTRICS EVENT EMITTER
================================ */
function sendToQualtrics(type, data = {}) {
  window.parent.postMessage({ type, ...data }, "*");
}

/* ===============================
   HELPERS
================================ */
function initials(name) {
  return name.split(/\s+/).map(w => w[0]).join("").slice(0, 2).toUpperCase();
}

function colorFromName(name) {
  const colors = [
    "linear-gradient(135deg,#1f6feb,#3b82f6)",
    "linear-gradient(135deg,#10b981,#34d399)",
    "linear-gradient(135deg,#f59e0b,#fbbf24)",
    "linear-gradient(135deg,#ec4899,#f472b6)",
    "linear-gradient(135deg,#6366f1,#8b5cf6)"
  ];
  return colors[name.charCodeAt(0) % colors.length];
}

function highlight(text) {
  return text
    .replace(/(@[a-zA-Z0-9_]+)/g, '<span class="highlight-mention">$1</span>')
    .replace(/(#[a-zA-Z0-9_]+)/g, '<span class="highlight-hashtag">$1</span>');
}

/* ===============================
   STATE
================================ */
const postId = new URLSearchParams(location.search).get("id");
let timelineState = JSON.parse(sessionStorage.getItem("timelineState") || "{}");

let state = timelineState[postId] || {
  likes: 0,
  retweets: 0,
  comments: [],
  liked: false,
  retweeted: false
};

function saveState() {
  timelineState[postId] = state;
  sessionStorage.setItem("timelineState", JSON.stringify(timelineState));
}

/* ===============================
   LOAD POST AND THREAD
================================ */
const thread = document.getElementById("thread");

fetch("../data/posts.json")
  .then(r => r.json())
  .then(posts => {
    const post = posts.find(p => p.id === postId);
    if (!post) return;

    // initialize state counts from post
    if (!state.initialized) {
      state.likes = post.likes || 0;
      state.retweets = post.retweets || 0;
      state.initialized = true;
      saveState();
    }

    renderMainPost(post);
    if(post.aiSummary) renderAISummary(post);
    post.replies.forEach(renderReply);
    renderUserComments();
  });

/* ===============================
   RENDER FUNCTIONS
================================ */
function renderMainPost(p) {
  const wrapper = document.createElement("div");
  wrapper.className = "post";

  wrapper.innerHTML = `
    <div class="avatar" style="background:${colorFromName(p.author)}">
      ${initials(p.author)}
    </div>
    <div class="content">
      <div class="meta">
        <span class="name">${p.author}</span>
        <span class="handle">${p.handle}</span> ¬∑
        <span class="time">${p.timestamp}</span>
      </div>
      <div class="text">${highlight(p.text)}</div>
      ${p.image ? `<img src="../${p.image}" class="thumb">` : ""}
      <div class="actions">
        <button class="like ${state.liked ? "liked" : ""}">‚ù§Ô∏è <span>${state.likes}</span></button>
        <button class="retweet ${state.retweeted ? "retweeted" : ""}">üîÅ <span>${state.retweets}</span></button>
        <button class="comment">üí¨ <span>${state.comments.length}</span></button>
      </div>
      <div class="comment-box" style="display:none;">
        <textarea placeholder="Write a comment..."></textarea>
        <button class="emoji-btn">üòÄ</button>
        <button>Submit</button>
      </div>
      <div class="comment-section"></div>
    </div>
  `;

  thread.appendChild(wrapper);

  const likeBtn = wrapper.querySelector(".like");
  const rtBtn = wrapper.querySelector(".retweet");
  const commentBtn = wrapper.querySelector(".comment");
  const commentBox = wrapper.querySelector(".comment-box");
  const submitBtn = commentBox.querySelector("button:last-of-type");
  const emojiBtn = commentBox.querySelector(".emoji-btn");
  const ta = commentBox.querySelector("textarea");

  /* --- Like --- */
  likeBtn.onclick = () => {
    state.liked = !state.liked;
    state.likes += state.liked ? 1 : -1;
    likeBtn.classList.toggle("liked", state.liked);
    likeBtn.querySelector("span").textContent = state.likes;

    sendToQualtrics("USER_LIKE", { postId, count: state.likes });
    saveState();
  };

  /* --- Retweet --- */
  rtBtn.onclick = () => {
    state.retweeted = !state.retweeted;
    state.retweets += state.retweeted ? 1 : -1;
    rtBtn.classList.toggle("retweeted", state.retweeted);
    rtBtn.querySelector("span").textContent = state.retweets;

    sendToQualtrics("USER_RETWEET", { postId, count: state.retweets });
    saveState();
  };

  /* --- Comment toggle --- */
  commentBtn.onclick = () => {
    commentBox.style.display = "block";
    ta.focus();
    sendToQualtrics("COMMENT_BOX_OPEN", { postId });
  };

  /* --- Emoji picker --- */
  const picker = new EmojiButton({ position: 'top-end' });
  emojiBtn.addEventListener('click', () => picker.togglePicker(emojiBtn));
  picker.on('emoji', emoji => {
    ta.value += emoji;
    ta.focus();
  });

  /* --- Submit comment --- */
  submitBtn.onclick = () => {
    const txt = ta.value.trim();
    if (!txt) return;
    state.comments.push(txt);
    ta.value = "";
    commentBox.style.display = "none";
    renderUserComments();
    commentBtn.querySelector("span").textContent = state.comments.length;

    sendToQualtrics("USER_COMMENT", { postId, text: txt });
    saveState();
  };
}

/* --- AI SUMMARY --- */
function renderAISummary(p) {
  const box = document.createElement("div");
  box.className = "ai-summary";
  box.innerHTML = `
    <div class="avatar">ü§ñ</div>
    <div class="content">
      <div class="name">AI Summary</div>
      <div class="text">${highlight(p.aiSummary)}</div>
    </div>
  `;
  thread.appendChild(box);
}

/* --- Replies --- */
function renderReply(r) {
  const wrapper = document.createElement("div");
  wrapper.className = "post";
  wrapper.innerHTML = `
    <div class="avatar" style="background:${colorFromName(r.author)}">
      ${initials(r.author)}
    </div>
    <div class="content">
      <div class="name">${r.author}</div>
      <div class="text">${highlight(r.text)}</div>
    </div>
  `;
  thread.appendChild(wrapper);
}

/* --- User Comments --- */
function renderUserComments() {
  const section = document.querySelector(".comment-section");
  if (!section) return;

  section.innerHTML = state.comments
    .map(c => `<div class="reply"><strong>You:</strong> ${highlight(c)}</div>`)
    .join("");
}

/* ===============================
   SCROLL DEPTH
================================ */
let maxScroll = 0;
window.addEventListener("scroll", () => {
  const docHeight = document.documentElement.scrollHeight - window.innerHeight;
  const depth = Math.round((window.scrollY / docHeight) * 100);
  if (depth > maxScroll) {
    maxScroll = depth;
    sendToQualtrics("SCROLL_DEPTH", { depth });
  }
});

/* ===============================
   TIME ON PAGE
================================ */
const pageStart = Date.now();
window.addEventListener("beforeunload", () => {
  sendToQualtrics("TIME_ON_PAGE", { ms: Date.now() - pageStart });
});
</script>

</body>
</html>
